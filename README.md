# snap-nbd-server

一个基于 NBD (Network Block Device) 协议的块设备快照服务器，支持写时复制（Copy-on-Write）功能。

## 主要用途

这个服务器主要用于块设备的快照和备份场景：

1. **块设备快照**
   - 创建块设备的即时快照
   - 所有修改都是写时复制的，不影响原始设备
   - 适合用于系统备份和恢复

2. **安全的块设备测试**
   - 可以安全地测试对块设备的修改
   - 所有修改都存储在单独的扇区文件中
   - 测试完成后可以轻松回滚

3. **虚拟机镜像管理**
   - 支持镜像文件作为后端
   - 可以创建镜像的多个快照
   - 适合用于虚拟机模板管理

4. **系统备份**
   - 支持原始块设备作为后端
   - 可以创建系统的完整备份
   - 支持增量备份（只存储修改的扇区）

## 功能特点

- 支持原始块设备（raw device）或镜像文件作为后端
- 支持写时复制（Copy-on-Write）功能，每个扇区单独存储
- 支持日志记录，记录所有读写操作
- 支持 TCP 网络传输
- 扇区文件采用四级目录结构，有效分散文件数量

## 使用方法

### 编译

```bash
make        # 编译服务器
make clean  # 清理编译产物
```

### 运行服务器

```bash
# 必需参数
-device     # 后端设备或镜像文件路径
-sector-dir # 扇区文件存储目录
-listen     # 监听地址，默认 :10809

# 可选参数
-sector-size # 扇区大小，默认 4096（必须是 512 的 2 次方倍数）
-log        # 日志文件路径，默认输出到标准错误

# 示例
./nbd-server -device /dev/sdX -sector-dir /path/to/sectors -listen :10809
./nbd-server -device /dev/sdX -sector-dir /path/to/sectors -sector-size 8192 -log /path/to/log.txt
```

### 客户端连接

使用系统自带的 nbd-client 连接：

```bash
# 连接服务器
nbd-client server-ip 10809 /dev/nbd0

# 断开连接
nbd-client -d /dev/nbd0
```

## 扇区文件结构

扇区文件采用四级目录结构，每级1字节（2位十六进制）：
```
sector-dir/
  ├── 78/          # 最低字节
  │   └── 56/      # 次低字节
  │       └── 34/  # 次高字节
  │           └── 12/  # 最高字节
  │               └── 0000000012345678_00001000.sector
```

## 注意事项

1. 需要 root 权限运行
2. 扇区大小必须是 512 的 2 次方倍数
3. 建议在生产环境中启用日志记录
4. 确保扇区目录有足够的磁盘空间 